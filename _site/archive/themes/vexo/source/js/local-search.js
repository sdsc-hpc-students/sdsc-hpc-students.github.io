document.addEventListener("DOMContentLoaded",(()=>{let e,t=!1,n=!0,r="/search.xml";0===r.length?r="search.xml":r.endsWith("json")&&(n=!1);const o=document.querySelector(".search-input"),s=document.getElementById("search-result"),l=(e,t,n)=>{let r=e.length;if(0===r)return[];let o=0,s=[],l=[];for(n||(t=t.toLowerCase(),e=e.toLowerCase());(s=t.indexOf(e,o))>-1;)l.push({position:s,word:e}),o=s+r;return l},i=(e,t,n,r)=>{let o=n[n.length-1],{position:s,word:l}=o,i=[],a=0;for(;s+l.length<=t&&0!==n.length;){l===r&&a++,i.push({position:s,length:l.length});let e=s+l.length;for(n.pop();0!==n.length&&(o=n[n.length-1],s=o.position,l=o.word,e>s);)n.pop()}return{hits:i,start:e,end:t,searchTextCount:a}},a=(e,t)=>{let n="",r=t.start;return t.hits.forEach((t=>{n+=e.substring(r,t.position);let o=t.position+t.length;n+=`<b class="search-keyword">${e.substring(t.position,o)}</b>`,r=o})),n+=e.substring(r,t.end),n},c=()=>{if(!t)return;let n=o.value.trim().toLowerCase(),r=n.split(/[-\s]+/);r.length>1&&r.push(n);let c=[];n.length>0&&e.forEach((({title:e,content:t,url:o})=>{let s=e.toLowerCase(),h=t.toLowerCase(),u=[],d=[],p=0;if(r.forEach((e=>{u=u.concat(l(e,s,!1)),d=d.concat(l(e,h,!1))})),u.length>0||d.length>0){let r=u.length+d.length;[u,d].forEach((e=>{e.sort(((e,t)=>t.position!==e.position?t.position-e.position:e.word.length-t.word.length))}));let s=[];if(0!==u.length){let t=i(0,e.length,u,n);p+=t.searchTextCountInSlice,s.push(t)}let l=[];for(;0!==d.length;){let e=d[d.length-1],{position:r,word:o}=e,s=r-20,a=r+80;s<0&&(s=0),a<r+o.length&&(a=r+o.length),a>t.length&&(a=t.length);let c=i(s,a,d,n);p+=c.searchTextCountInSlice,l.push(c)}l.sort(((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start));let h=parseInt(1,10);h>=0&&(l=l.slice(0,h));let g="";0!==s.length?g+=`<li class="search-result-element"><a href="${o}" class="search-result-title">${a(e,s[0])}</a>`:g+=`<li class="search-result-element"><a href="${o}" class="search-result-title">${e}</a>`,l.forEach((e=>{g+=`<a href="${o}"><p class="search-result">${a(t,e)}...</p></a>`})),g+="</li>",c.push({item:g,id:c.length,hitCount:r,searchTextCount:p})}})),1===r.length&&""===r[0]?s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x"></i></div>':0===c.length?s.innerHTML='<div id="no-result"><i class="far fa-frown fa-5x"></i></div>':(c.sort(((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id)),s.innerHTML=`<ul class="search-result-list">${c.map((e=>e.item)).join("")}</ul>`,window.pjax&&window.pjax.refresh(s))},h=()=>{fetch(""+r).then((e=>e.text())).then((r=>{t=!0,e=n?[...(new DOMParser).parseFromString(r,"text/xml").querySelectorAll("entry")].map((e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent}))):JSON.parse(r),e=e.filter((e=>e.title)).map((e=>(e.title=e.title.trim(),e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"",e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/"),e))),document.getElementById("no-result").innerHTML='<i class="fa fa-search fa-5x"></i>',c()}))};o.addEventListener("input",c),document.querySelectorAll(".popup-trigger").forEach((e=>{e.addEventListener("click",(()=>{document.body.style.overflow="hidden",document.querySelector(".search-pop-overlay").classList.add("search-active"),o.focus(),t||h()}))}));const u=()=>{document.body.style.overflow="",document.querySelector(".search-pop-overlay").classList.remove("search-active")};document.querySelector(".search-pop-overlay").addEventListener("click",(e=>{e.target===document.querySelector(".search-pop-overlay")&&u()})),document.querySelector(".popup-btn-close").addEventListener("click",u),window.addEventListener("pjax:success",u),window.addEventListener("keyup",(e=>{"Escape"===e.key&&u()}))}));